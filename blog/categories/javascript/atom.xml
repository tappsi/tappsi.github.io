<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Javascript | Tappsi's Engineering and Technology Blog]]></title>
  <link href="http://tappsi.github.io/blog/categories/javascript/atom.xml" rel="self"/>
  <link href="http://tappsi.github.io/"/>
  <updated>2017-01-23T10:29:08-05:00</updated>
  <id>http://tappsi.github.io/</id>
  <author>
    <name><![CDATA[Tappsi]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Cómo Pintar Polígonos en Mapbox Usando Geohashes]]></title>
    <link href="http://tappsi.github.io/blog/2016/11/28/como-pintar-poligonos-en-mapbox-usando-geohashes/"/>
    <updated>2016-11-28T11:16:14-05:00</updated>
    <id>http://tappsi.github.io/blog/2016/11/28/como-pintar-poligonos-en-mapbox-usando-geohashes</id>
    <content type="html"><![CDATA[<p>En nuestro ejemplo tenemos información acerca de velocidades (<em>km/h</em>) para cada sector de nuestra ciudad representado por un geohash:</p>

<p><figure class='code'><figcaption><span>geohashes.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="err">&amp;ldquo;d2g62s&amp;rdquo;:</span> <span class="err">18.0,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;d2g68c&amp;rdquo;:</span> <span class="err">36.33,</span>
</span><span class='line'>    <span class="err">&amp;ldquo;d2g74k&amp;rdquo;:</span> <span class="err">21.32</span>
</span><span class='line'>    <span class="err">//</span> <span class="err">etc.</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Lo primero que vamos a hacer, es obtener las coordenadas de los sectores a partir de la cadena de geohash. Para esto vamos a usar una librería de Python llamanda <a href="https://github.com/hkwi/python-geohash">python-geohash</a>. Usando el método <code>bbox</code> de ésta librería, podemos potener las coordenadas de los puntos extremos:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">blockquote</span><span class="o">&gt;&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="kn">import</span> <span class="nn">geohash</span>
</span><span class='line'><span class="n">gh</span> <span class="o">=</span> <span class="n">geohash</span><span class="o">.</span><span class="n">bbox</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">d2g628</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;)</span>
</span><span class='line'><span class="p">{</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">e</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="o">-</span><span class="mf">74.146728515625</span><span class="p">,</span>
</span><span class='line'> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">n</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="mf">4.6197509765625</span><span class="p">,</span>
</span><span class='line'> <span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span><span class="n">s</span><span class="s">&#39;: 4.6142578125,</span>
</span><span class='line'> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">w</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="o">-</span><span class="mf">74.15771484375</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></p></blockquote>

<p>donde <code>n</code> es el norte, <code>s</code> - el sur,  <code>w</code> - el oeste y <code>e</code> es el este. Entonces los puntos serán <code>(-74.15771484375, 4.6197509765625)</code>, <code>(-74.146728515625, 4.6197509765625)</code>, <code>(-74.14672851562, 4.6142578125)</code> y <code>(-74.15771484375, 4.6142578125)</code>.</p>

<p>Ahora construimos una vista (en éste ejemplo usamos Flask) para devolver un <a href="http://leafletjs.com/examples/geojson/">GeoJSON</a>, que vamos a consumir desde el código JavaScript.</p>

<p><figure class='code'><figcaption><span>views.py </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">geohash</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="nd">@main.route</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="o">/</span><span class="n">maps</span><span class="o">/</span><span class="n">speeds</span><span class="o">-</span><span class="nb">map</span><span class="o">-</span><span class="n">data</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">speeds_map_data</span><span class="p">():</span>
</span><span class='line'>    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>    <span class="n">speeds_hash</span> <span class="o">=</span> <span class="n">get_speeds_json</span><span class="p">()</span>
</span><span class='line'>    <span class="k">for</span> <span class="nb">hash</span><span class="p">,</span> <span class="n">speed</span> <span class="ow">in</span> <span class="n">speeds_hash</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
</span><span class='line'>        <span class="n">gh</span> <span class="o">=</span> <span class="n">geohash</span><span class="o">.</span><span class="n">bbox</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span>
</span><span class='line'>        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
</span><span class='line'>            <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">type</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">Feature</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;,</span>
</span><span class='line'>            <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">properties</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="p">{</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">popupContent</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;{}</span> <span class="n">km</span><span class="o">/</span><span class="n">h</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">speed</span><span class="p">),</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">style</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="p">{</span>
</span><span class='line'>                    <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">weight</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>                    <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">color</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="p">;</span><span class="c">#999&amp;rdquo;,</span>
</span><span class='line'>                    <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">opacity</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                    <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">fillColor</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>                    <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">fillOpacity</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="mf">0.7</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">geometry</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="p">{</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">type</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">Polygon</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;,</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">coordinates</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="p">[[</span>
</span><span class='line'>                    <span class="p">[</span><span class="n">gh</span><span class="p">[</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">w</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;],</span> <span class="n">gh</span><span class="p">[</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">n</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;]],</span> <span class="p">[</span><span class="n">gh</span><span class="p">[</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">e</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;],</span> <span class="n">gh</span><span class="p">[</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">n</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;]],</span>
</span><span class='line'>                    <span class="p">[</span><span class="n">gh</span><span class="p">[</span><span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">e</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;],</span> <span class="n">gh</span><span class="p">[</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;</span><span class="n">s</span><span class="s">&#39;]], [gh[&amp;lsquo;w&amp;rsquo;], gh[&amp;rsquo;s&#39;</span><span class="p">]],</span>
</span><span class='line'>                <span class="p">]]</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="nb">type</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">FeatureCollection</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">lsquo</span><span class="p">;</span><span class="n">features</span><span class="o">&amp;</span><span class="n">rsquo</span><span class="p">;:</span> <span class="n">features</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Ahora sólo nos falta crear la plantilla HTML</p>

<p><figure class='code'><figcaption><span>map.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;map&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>y el archivo JavaScript para crear el mapa y obtener los datos de nuestra vista:</p>

<p><figure class='code'><figcaption><span>map.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">use</span> <span class="nx">strict</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;;</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="nx">L</span><span class="p">.</span><span class="nx">mapbox</span><span class="p">.</span><span class="nx">accessToken</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">YOUR_MAPBOX_ACCESS_TOKEN</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;;</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="c1">// Crear un mapa, especificando el centro y zoom</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">mapbox</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">map</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;,</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="nx">mapbox</span><span class="p">.</span><span class="nx">streets</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;).</span><span class="nx">setView</span><span class="p">([</span><span class="mf">4.66336863727521</span><span class="p">,</span> <span class="o">-</span><span class="mf">74.07231699675322</span><span class="p">],</span> <span class="mi">12</span><span class="p">)</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="c1">// Obtener el GeoJSON de nuestra vista</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="err">/maps/speeds-map-data&amp;rsquo;, function (data) {</span>
</span><span class='line'>    <span class="nx">L</span><span class="p">.</span><span class="nx">geoJson</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">style</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">onEachFeature</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">feature</span><span class="p">,</span> <span class="nx">layer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Mostrar un pop-up con la velocidad mara cada sector</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">popupContent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nx">lsquo</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">rsquo</span><span class="p">;;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span> <span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span><span class="o">&amp;</span><span class="nx">amp</span><span class="p">;</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">popupContent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">popupContent</span> <span class="o">+=</span> <span class="nx">feature</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">popupContent</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">layer</span><span class="p">.</span><span class="nx">bindPopup</span><span class="p">(</span><span class="nx">popupContent</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Y voilà: podemos mostrar un mapa de calor a nuestros usuarios:</p>

<p><img src="/images/posts/mapbox_polygons.png" title="Polígonos" ></p>

<h2>Referentes</h2>

<ul>
<li><a href="http://leafletjs.com/examples/geojson/">Using GeoJSON with Leaflet</a></li>
<li><a href="http://geojson.org/geojson-spec.html">The GeoJSON Format Specification</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
